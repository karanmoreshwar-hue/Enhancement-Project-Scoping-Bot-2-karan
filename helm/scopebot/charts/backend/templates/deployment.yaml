apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "backend.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{ include "backend.labels" . | nindent 4 }}
spec:
  replicas: {{ .Values.replicaCount }}
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 0        # Don't create extra pods (prevents memory spike in Minikube)
      maxUnavailable: 1  # Allow old pod to terminate before new pod starts
  selector:
    matchLabels:
      {{ include "backend.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      labels:
        {{ include "backend.selectorLabels" . | nindent 8 }}
    spec:
      {{- if .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml .Values.imagePullSecrets | nindent 8 }}
      {{- end }}

      containers:
      - name: backend
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        ports:
        - name: http
          containerPort: {{ .Values.service.targetPort }}
          protocol: TCP
        env:
        # Non-sensitive environment variables
        - name: ANONYMIZED_TELEMETRY
          value: {{ .Values.env.ANONYMIZED_TELEMETRY | quote }}
        - name: USE_GEMINI
          value: {{ .Values.env.USE_GEMINI | quote }}
        - name: FRONTEND_URL
          value: {{ .Values.env.FRONTEND_URL | quote }}
        - name: VECTOR_DIM
          value: {{ .Values.env.VECTOR_DIM | quote }}
        - name: QDRANT_HOST
          value: {{ .Values.env.QDRANT_HOST | quote }}
        - name: QDRANT_PORT
          value: {{ .Values.env.QDRANT_PORT | quote }}
        - name: QDRANT_COLLECTION
          value: {{ .Values.env.QDRANT_COLLECTION | quote }}
        - name: LOCAL_STORAGE_PATH
          value: {{ .Values.volumes.localStoragePath | quote }}
        - name: KNOWLEDGE_BASE_PATH
          value: {{ .Values.volumes.knowledgeBasePath | quote }}
        - name: CHROMA_PERSIST_DIR
          value: {{ .Values.volumes.chromaPersistDir | quote }}
        # Sensitive environment variables from secret
        - name: GEMINI_API_KEY
          valueFrom:
            secretKeyRef:
              name: {{ include "backend.fullname" . }}-secret
              key: GEMINI_API_KEY
        - name: GEMINI_MODEL
          valueFrom:
            secretKeyRef:
              name: {{ include "backend.fullname" . }}-secret
              key: GEMINI_MODEL
        - name: JINA_API_KEY
          valueFrom:
            secretKeyRef:
              name: {{ include "backend.fullname" . }}-secret
              key: JINA_API_KEY
        - name: JINA_MODEL
          valueFrom:
            secretKeyRef:
              name: {{ include "backend.fullname" . }}-secret
              key: JINA_MODEL
        - name: POSTGRES_DB
          valueFrom:
            secretKeyRef:
              name: {{ include "backend.fullname" . }}-secret
              key: POSTGRES_DB
        - name: POSTGRES_USER
          valueFrom:
            secretKeyRef:
              name: {{ include "backend.fullname" . }}-secret
              key: POSTGRES_USER
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ include "backend.fullname" . }}-secret
              key: POSTGRES_PASSWORD
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: {{ include "backend.fullname" . }}-secret
              key: DATABASE_URL
        - name: SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: {{ include "backend.fullname" . }}-secret
              key: SECRET_KEY
        - name: ALGORITHM
          valueFrom:
            secretKeyRef:
              name: {{ include "backend.fullname" . }}-secret
              key: ALGORITHM
        - name: ACCESS_TOKEN_EXPIRE_MINUTES
          valueFrom:
            secretKeyRef:
              name: {{ include "backend.fullname" . }}-secret
              key: ACCESS_TOKEN_EXPIRE_MINUTES
        - name: REFRESH_TOKEN_EXPIRE_DAYS
          valueFrom:
            secretKeyRef:
              name: {{ include "backend.fullname" . }}-secret
              key: REFRESH_TOKEN_EXPIRE_DAYS
        {{- if .Values.secrets.SMTP_HOST }}
        - name: SMTP_HOST
          valueFrom:
            secretKeyRef:
              name: {{ include "backend.fullname" . }}-secret
              key: SMTP_HOST
        - name: SMTP_PORT
          valueFrom:
            secretKeyRef:
              name: {{ include "backend.fullname" . }}-secret
              key: SMTP_PORT
        - name: SMTP_USER
          valueFrom:
            secretKeyRef:
              name: {{ include "backend.fullname" . }}-secret
              key: SMTP_USER
        - name: SMTP_PASS
          valueFrom:
            secretKeyRef:
              name: {{ include "backend.fullname" . }}-secret
              key: SMTP_PASS
        {{- end }}
        {{- if .Values.secrets.OLLAMA_HOST }}
        - name: OLLAMA_HOST
          valueFrom:
            secretKeyRef:
              name: {{ include "backend.fullname" . }}-secret
              key: OLLAMA_HOST
        {{- end }}
        {{- if .Values.secrets.OLLAMA_MODEL }}
        - name: OLLAMA_MODEL
          valueFrom:
            secretKeyRef:
              name: {{ include "backend.fullname" . }}-secret
              key: OLLAMA_MODEL
        {{- end }}
        {{- if .Values.secrets.OLLAMA_EMBED_MODEL }}
        - name: OLLAMA_EMBED_MODEL
          valueFrom:
            secretKeyRef:
              name: {{ include "backend.fullname" . }}-secret
              key: OLLAMA_EMBED_MODEL
        {{- end }}
        {{- if .Values.secrets.AZURE_STORAGE_ACCOUNT }}
        - name: AZURE_STORAGE_ACCOUNT
          valueFrom:
            secretKeyRef:
              name: {{ include "backend.fullname" . }}-secret
              key: AZURE_STORAGE_ACCOUNT
        {{- end }}
        {{- if .Values.secrets.AZURE_STORAGE_KEY }}
        - name: AZURE_STORAGE_KEY
          valueFrom:
            secretKeyRef:
              name: {{ include "backend.fullname" . }}-secret
              key: AZURE_STORAGE_KEY
        {{- end }}
        {{- if .Values.secrets.AZURE_STORAGE_CONTAINER }}
        - name: AZURE_STORAGE_CONTAINER
          valueFrom:
            secretKeyRef:
              name: {{ include "backend.fullname" . }}-secret
              key: AZURE_STORAGE_CONTAINER
        {{- end }}
        volumeMounts:
        - name: storage
          mountPath: {{ .Values.volumes.localStoragePath }}
        - name: knowledge-base
          mountPath: {{ .Values.volumes.knowledgeBasePath }}
        - name: chroma-data
          mountPath: {{ .Values.volumes.chromaPersistDir }}
        resources:
          {{- toYaml .Values.resources | nindent 10 }}
      volumes:
      - name: storage
        emptyDir: {}
      - name: knowledge-base
        emptyDir: {}
      - name: chroma-data
        emptyDir: {}